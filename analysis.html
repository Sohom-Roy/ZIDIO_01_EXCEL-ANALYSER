<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X-Track - Analysis</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      color: #fff;
      background: #000;
    }
    #bgVideo {
      position: fixed;
      top: 0; left: 0;
      min-width: 100vw; min-height: 100vh;
      object-fit: cover;
      z-index: -1;
      opacity: 0.45;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .navbar .logo {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      text-decoration: none;
    }
    .navbar .actions button {
      background: #ff4d4d;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    .navbar .actions button:hover {
      background: #d93636;
    }
    .content {
      padding: 30px;
      max-width: 1200px;
      margin: auto;
    }
    h1 {
      font-size: 36px;
      margin-bottom: 10px;
      font-weight: 700;
      text-align: center;
    }
    h2 {
      margin: 20px 0 10px;
      font-weight: 500;
    }
    #table-preview {
      max-height: 350px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      background: rgba(0,0,0,0.4);
      margin-bottom: 25px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
    }
    th, td {
      border: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background: rgba(72, 52, 212, 0.6);
      font-weight: 500;
      position: sticky;
      top: 0;
    }
    .controls {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    select, button {
      padding: 10px 15px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
    }
    select {
      flex: 1;
    }
    .plot-btn {
      background: linear-gradient(90deg,#ff9800 60%,#ffb74d 100%);
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    .plot-btn:hover {
      transform: scale(1.05);
    }
    #chart {
      width: 100%;
      height: 600px;
      background: rgba(0,0,0,0.4);
      border-radius: 12px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <!-- Background Video -->
  <video autoplay muted loop id="bgVideo">
    <source src="video.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>

  <nav class="navbar">
    <a href="home.html" class="logo">ðŸ“Š X-Track Analysis</a>
    <div class="actions">
      <button onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="content">
    <h1>Excel Data Analysis</h1>

    <h2>Data Preview</h2>
    <div id="table-preview">
      <table id="data-table"></table>
    </div>

    <h2>Chart Controls</h2>
    <div class="controls">
      <select id="chart-type" onchange="updateControls()">
        <option value="">-- Select Chart Type --</option>
        <option value="bar">Bar Chart</option>
        <option value="column">Column Chart</option>
        <option value="line">Line Chart</option>
        <option value="area">Area Chart</option>
        <option value="pie">Pie Chart</option>
        <option value="scatter3d">3D Scatter Chart</option>
      </select>

      <!-- Bar/Column/Line/Area controls -->
      <div id="xy-legend-group" style="display:none; gap:10px; flex:1;">
        <select id="x-axis"><option value="">-- X-Axis --</option></select>
        <select id="y-axis"><option value="">-- Y-Axis --</option></select>
        <select id="legend"><option value="">-- Legend --</option></select>
      </div>

      <!-- Pie controls -->
      <div id="pie-group" style="display:none; gap:10px; flex:1;">
        <select id="pie-legend"><option value="">-- Legends --</option></select>
        <select id="pie-values"><option value="">-- Values --</option></select>
        <select id="pie-details"><option value="">-- Details (Optional) --</option></select>
      </div>

      <!-- 3D Scatter controls -->
      <div id="scatter3d-group" style="display:none; gap:10px; flex:1;">
        <select id="x3d"><option value="">-- X-Axis --</option></select>
        <select id="y3d"><option value="">-- Y-Axis --</option></select>
        <select id="z3d"><option value="">-- Z-Axis --</option></select>
      </div>

      <button class="plot-btn" onclick="plotChart()">Plot Chart</button>
    </div>

    <h2>Chart</h2>
    <div id="chart"></div>
  </div>

  <script>
    let excelData = [];
    let headers = [];

    // Load stored data
    window.onload = function() {
      const storedData = sessionStorage.getItem('excelData');
      if (storedData) {
        excelData = JSON.parse(storedData);
        if (excelData.length > 0) {
          headers = excelData[0];
          populateDropdowns();
          renderTable();
        }
      } else {
        alert("No file uploaded. Redirecting...");
        window.location.href = "users.html";
      }
    };

    function populateDropdowns() {
      const dropdownIds = [
        "x-axis","y-axis","legend",
        "pie-legend","pie-values","pie-details",
        "x3d","y3d","z3d"
      ];
      dropdownIds.forEach(id => {
        const sel = document.getElementById(id);
        headers.forEach(h => {
          const opt = document.createElement("option");
          opt.value = h;
          opt.textContent = h;
          sel.appendChild(opt.cloneNode(true));
        });
      });
    }

    function updateControls() {
      document.getElementById("xy-legend-group").style.display = "none";
      document.getElementById("pie-group").style.display = "none";
      document.getElementById("scatter3d-group").style.display = "none";

      const type = document.getElementById("chart-type").value;
      if (["bar","column","line","area"].includes(type)) {
        document.getElementById("xy-legend-group").style.display = "flex";
      } else if (type === "pie") {
        document.getElementById("pie-group").style.display = "flex";
      } else if (type === "scatter3d") {
        document.getElementById("scatter3d-group").style.display = "flex";
      }
    }

    function renderTable() {
      const table = document.getElementById('data-table');
      table.innerHTML = "";
      const headerRow = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      for (let i = 1; i < Math.min(21, excelData.length); i++) {
        const row = document.createElement('tr');
        excelData[i].forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          row.appendChild(td);
        });
        table.appendChild(row);
      }
    }

    function plotChart() {
      const type = document.getElementById("chart-type").value;
      let trace = {}, layout = { title: "" };

      if (["bar","column","line","area"].includes(type)) {
        const xCol = document.getElementById("x-axis").value;
        const yCol = document.getElementById("y-axis").value;
        const legendCol = document.getElementById("legend").value;
        if (!xCol || !yCol) return alert("Please select X and Y axis.");

        const xi = headers.indexOf(xCol), yi = headers.indexOf(yCol);
        const xData = excelData.slice(1).map(r => r[xi]);
        const yData = excelData.slice(1).map(r => Number(r[yi]) || 0);

        if (type === "bar") trace = { x: xData, y: yData, type: "bar", name: legendCol || yCol };
        if (type === "column") trace = { x: xData, y: yData, type: "bar", orientation: "v", name: legendCol || yCol };
        if (type === "line") trace = {
          x: xData, y: yData, type: "scatter", mode: "lines+markers",
          line: { shape: "linear", width: 2, color: "#3366cc" },
          marker: { size: 6, color: "#3366cc", line: { width: 1, color: "#fff" } },
          name: legendCol || yCol
        };
        if (type === "area") trace = {
          x: xData, y: yData, type: "scatter", mode: "lines", fill: "tozeroy", name: legendCol || yCol
        };

        layout = { title: `${yCol} by ${xCol}`, xaxis: { title: xCol }, yaxis: { title: yCol } };
      }

      else if (type === "pie") {
        const legCol = document.getElementById("pie-legend").value;
        const valCol = document.getElementById("pie-values").value;
        const detCol = document.getElementById("pie-details").value;
        if (!legCol || !valCol) return alert("Please select Legends and Values.");

        const li = headers.indexOf(legCol);
        const vi = headers.indexOf(valCol);
        const di = detCol ? headers.indexOf(detCol) : -1;

        let labels = excelData.slice(1).map(r => r[li] ?? "");
        const values = excelData.slice(1).map(r => Number(r[vi]) || 0);

        if (di >= 0) {
          const details = excelData.slice(1).map(r => r[di] ?? "");
          labels = labels.map((l, i) => details[i] ? `${l} (${details[i]})` : l);
        }

        trace = {
          labels, values, type: "pie",
          textinfo: "label+percent", hoverinfo: "label+value+percent"
        };
      }

      else if (type === "scatter3d") {
        const xCol = document.getElementById("x3d").value;
        const yCol = document.getElementById("y3d").value;
        const zCol = document.getElementById("z3d").value;
        if (!xCol || !yCol || !zCol) return alert("Please select X, Y and Z axes.");

        const xi = headers.indexOf(xCol), yi = headers.indexOf(yCol), zi = headers.indexOf(zCol);
        const xData = excelData.slice(1).map(r => r[xi]);
        const yData = excelData.slice(1).map(r => r[yi]);
        const zData = excelData.slice(1).map(r => r[zi]);

        trace = { x: xData, y: yData, z: zData, mode: "markers", type: "scatter3d" };
        layout.scene = { xaxis: { title: xCol }, yaxis: { title: yCol }, zaxis: { title: zCol } };
      }

      Plotly.newPlot("chart", [trace], layout);
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
